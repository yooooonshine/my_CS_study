# 머클 트리
----
![[Pasted image 20231027110837.png]]
HA는 Hash(TxA)를 sha256으로 해쉬한 것, 결과는 256bit이다.
즉 TxA를 해쉬한 값을 한번 더 해쉬한 게 HA이다.
HA+HB는 두 스트링을 이어 붙인 것이다.

이를 통해 아래 Tx를 임의로 바꾸면 해시값이 달라지므로 머클트리에서 끊어지게 된다.
또한 HB 트랜잭션이 변경되었는 지 확인하려면 depth만큼만 확인하면 된다.
![[Pasted image 20231027111336.png]]
예를 들면 이와 같이 HK를 확인하려면 HL, HIJ, HMNOF, HABCDEFGH의 도움만 받으면 된다.

# Mining
* 채굴은 비트코인을 견고하게 만든다.
* 또한 채굴은 비트코인을 견고하게 만들며, 중앙 권력없이 네트워크 합의를 가능하게 한다.
* 채굴 보상과, transaction fee는 채굴자가 채굴을 하는 동기를 제공한다.
* 트랜잭션이 블록체인에 포함되었다 == confirm되었다.
* 시작이 지날수록 block reward는 감소하고 있고, 이를 transaction fee가 대체하게 될 것이다.

## finding valid blocks
* 보류된 transaction pool에서 타당한 transaction들을 골라 merkle tree로 구성한다.
* 이전 블럭을 가리키는 header와 함께 block을 만든다.
* 문제를 푸는 nonce를 찾는다.

	## mining과정에서 nonce를 푸는 과정은 모두 똑같은 퍼즐을 푸는 거 아니야?
	아니다. 왜냐하면 어떤 트랜잭션을 포함시키는 지, 트랜잭션의 순서에 따라 hash값이 달라지므로 모두 다른 퍼즐을 푸는 것이다.
	또한 transaction에 코인을 받을 주소를 명시하기에 달라진다.
	![[Pasted image 20231204205741.png]]
	참고로 돈을 받을 마이너의 주소는 머클트리 가장 왼쪽에 기입한다.
	이를 coinbaseTransaction이라고 한다.
	이 트랜잭션은 기존에 존재하던 코인을 사용하는 것이 아니므로 input이 필요없다.
## Determining the difficulty
![[Pasted image 20231204205902.png]]
채굴 난이도는 매 2016블럭마다 다시 설정된다.
참고로 2016블럭은 대략 2주이다.
위는 새로운 난이도를 결정하는 식이다.
최근 2016블럭을 채굴하는 데 적은 시간이 걸렸다면 난도는 올라가며
최근 2016블럭을 채굴하는 데 많은 시간이 걸렸다면 난도는 감소한다.


# Decentralized Consensus
* 비트코인에는 중앙권력은 없지만, 각각의 모든 노드는 완전한 레코드라고 신뢰되는 장부에 대한 카피본을 가지고 있다.
* 블록체인은 중앙 권력에 의하여 만들어 지는 것은 아니지만, 모든 노드에 의하여 만들어진다.
* 탈중앙화된 합의는 네트워크 전역의 노드에 의하여 독립적으로 발생하느 4가지의 상호 작용으로 발생한다.
1. 모든 노드는 각각의 transaction에 대하여 verification을 한다.
2. 이러한 트랜잭션을 새 블럭에 넣어 채굴을 시도한다.
3. 모든 노드들은 새로운 블록에 대하여 verfication을 거쳐, 자신의 체인에 포함시킨다.
4. 어떤 블록 위에 내가 연결시킬지는 각자 판단한다.


# Independent Verification of Transactions
트랜잭션을 받은 노드는, 이 트랜잭션을 주변에 뿌리기 전에 트랜잭션을 verification한다. 만약 valid하면 주변으로 뿌리지만, invalid하면 노드는 transaction을 버린다.

각각의 노드는 트랜잭션에 대하여 다음을 확인한다.
* 트랜잭션의 syntax하고 data structure가 타당한지
* 트랜잭션 스크립트는 튜링 완전 허용하지 않는데, 이에 대해 적혀있는 스크립트가 타당한지
* 트랜잭션이 채굴된 블록에 없고, 트랜잭션이 utxo를 언급하고, 그것들이 사용되지 않았는 지
* 트랜잭션 사이즈가 최대 사이즈 이하인지(지금은 witness data 제외하고 1mb이다.)




# Coinbase transaction
![[Pasted image 20231030170958.png]]
vin 안의 coinbase값은 2^32개의 nonse를 다 넣어봐도 답이 안 나올 경우 트랜잭션의 위치를 바꾸는 것은 시간이 오래걸리므로, 간단하게 coinbase Transaciton안의 coinbase값을 변경하는 것이다.

여기서 value는 보낼 코인 이는 채굴 비 하고  transaction fee를 합친 것이다.
address는 miner의 주소

# Extra Nonce Solution for Mining Hash Puzzles
기존에는 4byte의 nonce값을 바꾸는 것만 하더라도 충분히 답을 구할 수 있었으나, 채굴 난도가 올라가면서 4byte nonce를 모두 바꿔도 정답이 안나오는 경우가 생겼다.







# Changing Consensus Rules
consensus rule은 모든 노드가 합의를 하는 데 사용되는 알고리즘이지만.
시대의 변화에 맞추어 consensus규칙 또한 바뀔 수 있다.