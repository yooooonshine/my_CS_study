# 프록시
---
Member와 Team객체의 관계를 생각해보자.
Member가 연관관계의 주인이고, Member의 name과 Team의 name이 궁금하거나, 오직 Member의 name이 궁금한 상황이다.
전자는 Member엔티티도 가져오고, Team엔티티도 가져와야 한다.
후자는 오직 Member엔티티만 가져오는 게 성능상 좋다.
이와 같이 비즈니스에 따라, 한쪽만 사용하는 경우가 많거나 Team name과 Member name 둘 다 사용하는 경우가 많을 수도 있다.
따라서 jpa에서는 둘 다 가져오는데, 한쪽만 사용한다면 낭비가 심할 수 있고, 이를  jpa에서는 프록시와 지연로딩 등으로 처리한다.

결론적으로는, Member를 가져올때는 team객체에 대한 프록시 객체를 갖게 되며, 실질적으로 team name이 필요할 때 진짜 객체를 생성한다.

그럼 프록시가 무엇일까?
## 프록시
jpa에서는 `em.find`외에도  `em.getReference`라는 기능이 있다.
* `em.find`: 데이터베이스를 통해 실제 엔티티를 조회한다.
* `em.reference`: db 조회를 미루 가짜 엔티티 객체를 조회한다.
여기서 가짜 객체가 프록시이다.

다음과 같은 코드에서
```java
Member findMember = em.getReference(Member.class, member.getId()); //1
findMember.getUsername(); //2

```
1에서 `findMember`에 담긴 객체는 프록시 객체로 이에 대해
`findMember.getClass()`로 출력을 해보면 `MemberHibernateProxy$odcVHpjy`라고 뜨는 것을 볼 수 있다.
즉 실제 데이터베이스에서 가져오지 않았다.
이후 2에서 서버에 없는 정보를 요구하면 이 때 쿼리문이 날라가면서 Member객체를 가져오게 된다.

즉 필요할 때까지 가짜객체로 대체하고 있는 것이 프록시 객체이다.
## 프록시 특징
* 실제 클래스를 상속 받아서 만들기 때문에, 내부는 비어있지만, 외부는 실제 클래스와 모양이 같다.
* 사용자 입장에서는 프록시객체 실제 객체 구별할 필요없이 사용하면 된다.
* 프록시 객체는 처음 사용할 때 한번만 초기화 된다. 즉 특정 객체에 대해 두, 세개의 프록시 객체가 만들어지지 않고 기존의 프록시 객체를 사용한다.
* 실제 객체를 초기화 할때 프록시 객체가 실제 엔티티로 바뀌는 것이 아니다. 위임하여 가져올 뿐이다.
* 프록시 객체는 원본 엔티티를 상속받은 것이기에, 실제 객체와 타입이 다르다. 따라서 == 비교는 실패할 수 있으며, 대신에 instance of를 사용하자. 예를 들어 `member1.getClass == member2.getClass` 
* `em.getReference`를 호출하여도, 영속성 컨텍스트에 실제 엔티티가 있으면 실제 엔티티를 반환한다.
* 프록시 객체를 한번 만든 상태에서는 실제 객체가 영속성 컨텍스트에 있어도 `em.find`하면 프록시 객체가 반환된다.
* 프록시 객체를 초기화하지 않은 상태에서 프록시 객체를 영속성 컨텍스트에서 꺼내 준영속 상태로 만든다면, 프록시 객체를 초기화 할 수 없다.

참고: instanceOf type 이라면 type이거나 type을 상속받았으면 true를 return한다.
## 프록시 동작
![[Pasted image 20240106210856.png]]
* 프록시는 실제 객체의 참조(target)를 보관한다.
* 프록시를 실제 만들 때는 객체의 참조를 갖고 있지 않다.
* 실제 객체의 정보를 요구할 때에 객체의 참조를 갖게 되며, 프록시가 대신 실제 객체에게 정보를 받아, 클라이언트한테 건넨다.

## 프록시에 대한 확인을 할 수 있는 유틸리티
### 1. 프록시 인스턴스의 초기화 여부 확인
`emf.PersistenceUnitUtil.isLoaded(객체)`
### 2. 프록시 클래스 확인 방법
`entity.getClass()`
### 3. 프록시 강제 초기화
`org.hibernate.Hibernate.initialize(객체)`
참고로 jpa에는 강제 초기화가 없어서 객체.getName()등으로 없는 필드를 호출해서 초기화 시킨다.